"use strict";var e=require("os"),n=require("child_process"),t=require("fs"),r=require("path");function o(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var a=o(e),i=o(n),s=o(t),l=o(r),c={};Object.defineProperty(c,"__esModule",{value:!0});var d=a.default,u=i.default,p=s.default,f=l.default;function m(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var g=m(d),y=m(p),h=m(f);const w=g.default,v=/\s+at.*(?:\(|\s)(.*)\)?/,k=/^(?:(?:(?:node|(?:internal\/[\w/]*|.*node_modules\/(?:babel-polyfill|pirates)\/.*)?\w+)\.js:\d+:\d+)|native)/,b=void 0===w.homedir?"":w.homedir();class E extends Error{constructor(e){if(!Array.isArray(e))throw new TypeError("Expected input to be an Array, got "+typeof e);let n=(e=[...e].map((e=>e instanceof Error?e:null!==e&&"object"==typeof e?Object.assign(new Error(e.message),e):new Error(e)))).map((e=>"string"==typeof e.stack?((e,n)=>(n=Object.assign({pretty:!1},n),e.replace(/\\/g,"/").split("\n").filter((e=>{const n=e.match(v);if(null===n||!n[1])return!0;const t=n[1];return!t.includes(".app/Contents/Resources/electron.asar")&&!t.includes(".app/Contents/Resources/default_app.asar")&&!k.test(t)})).filter((e=>""!==e.trim())).map((e=>n.pretty?e.replace(v,((e,n)=>e.replace(n,n.replace(b,"~")))):e)).join("\n")))(e.stack).replace(/\s+at .*aggregate-error\/index.js:\d+:\d+\)?/g,""):String(e))).join("\n");n="\n"+((e,n=1,t)=>{if(t={indent:" ",includeEmptyLines:!1,...t},"string"!=typeof e)throw new TypeError(`Expected \`input\` to be a \`string\`, got \`${typeof e}\``);if("number"!=typeof n)throw new TypeError(`Expected \`count\` to be a \`number\`, got \`${typeof n}\``);if("string"!=typeof t.indent)throw new TypeError(`Expected \`options.indent\` to be a \`string\`, got \`${typeof t.indent}\``);if(0===n)return e;const r=t.includeEmptyLines?/^/gm:/^(?!\s*$)/gm;return e.replace(r,t.indent.repeat(n))})(n,4),super(n),this.name="AggregateError",Object.defineProperty(this,"_errors",{value:e})}*[Symbol.iterator](){for(const e of this._errors)yield e}}const P=E;var $={exports:{}},x={exports:{}};const j=(e,n,t)=>new Promise(((r,o)=>{if(t=Object.assign({concurrency:1/0},t),"function"!=typeof n)throw new TypeError("Mapper function is required");const{concurrency:a}=t;if(!("number"==typeof a&&a>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${a}\` (${typeof a})`);const i=[],s=e[Symbol.iterator]();let l=!1,c=!1,d=0,u=0;const p=()=>{if(l)return;const e=s.next(),t=u;if(u++,e.done)return c=!0,void(0===d&&r(i));d++,Promise.resolve(e.value).then((e=>n(e,t))).then((e=>{i[t]=e,d--,p()}),(e=>{l=!0,o(e)}))};for(let e=0;e<a&&(p(),!c);e++);}));x.exports=j,x.exports.default=j;const A=x.exports,C=async(e,n,t)=>(await A(e,((e,t)=>Promise.all([n(e,t),e])),t)).filter((e=>Boolean(e[0]))).map((e=>e[1]));$.exports=C,$.exports.default=C;var D=$.exports;const N=atom.inDevMode()||atom.inSpecMode();var T=/["'&<>]/,S=function(e){var n,t=""+e,r=T.exec(t);if(!r)return t;var o="",a=0,i=0;for(a=r.index;a<t.length;a++){switch(t.charCodeAt(a)){case 34:n="&quot;";break;case 38:n="&amp;";break;case 39:n="&#39;";break;case 60:n="&lt;";break;case 62:n="&gt;";break;default:continue}i!==a&&(o+=t.substring(i,a)),i=a+1,o+=n}return i!==a?o+t.substring(i,a):o};function I(e,n,t){let r;const o=async function(e,n,t){const r=u.spawn(e,n,t),o=new Promise(((e,n)=>{const o={stdout:r.stdout?[]:null,stderr:r.stderr?[]:null};r.on("error",n),r.stdout&&r.stdout.on("data",(function(e){o.stdout.push(e),t.handleStdout&&t.handleStdout(e)})),r.stderr&&r.stderr.on("data",(function(e){o.stderr.push(e),t.handleStderr&&t.handleStderr(e)})),r.on("close",(n=>{let r=null;null!=o.stdout&&(r=null===t.encoding||"buffer"===t.encoding?Buffer.concat(o.stdout):o.stdout.join(""));let a=null;null!=o.stderr&&(a=null===t.encoding||"buffer"===t.encoding?Buffer.concat(o.stderr):o.stderr.join("")),e({exitCode:n,stdout:r,stderr:a})}))}));return t.handleChildProcess(r),o}(e,n,{...t,handleChildProcess(e){r=e}});return o.kill=function(e){return r.kill(e)},o}const O=async function(e){return atom.packages.resolvePackagePath(e)};function q(e,n){if(!e)throw new Error(null!=n?n:"Invariant violation")}async function M(e){if(null==e.directory)return!0;if(null==e.minimumVersion)return!1;const n=await async function(e){{const n=await async function(e){var n;const t=atom.packages.getLoadedPackage(e.name);return null==t?null:null!==(n=t.metadata.version)&&void 0!==n?n:null}(e);if(n)return n}return async function(e){var n;const{directory:t}=e;if(null==t)return null;let r=null;try{r=JSON.parse(await y.default.promises.readFile(h.default.join(t,"package.json"),"utf8"))}catch(e){return null}return null!==(n=null==r?void 0:r.version)&&void 0!==n?n:null}(e)}(e);return null==n||1===function(e,n){for(var t=e.split("."),r=n.split("."),o=0;o<3;o++){var a=Number(t[o]),i=Number(r[o]);if(a>i)return 1;if(i>a)return-1;if(!isNaN(a)&&isNaN(i))return 1;if(isNaN(a)&&!isNaN(i))return-1}return 0}(e.minimumVersion,n)}const V=new Set(["âœ“","done"]),L=/(?:Installing|Moving) (.*?) to .* (.*)/;async function _(e){if("string"==typeof e)return{name:e,directory:await O(e)};if("name"in e)return{...e,directory:await O(e.name)};throw console.error("This package-deps entry is not valid. Please see https://github.com/steelbrain/package-deps#how-it-works",{entry:e}),Error("The package-deps entry is not valid. Please see https://github.com/steelbrain/package-deps#how-it-works")}let H=!0;var B=c.install=async function(e,n=!1){if(q("string"==typeof e&&e.length>0,"[Package-Deps] Package name is required"),t=e,(null!==(r=atom.config.get("atom-package-deps.ignored"))&&void 0!==r?r:[]).includes(t))return;var t,r;const o=await async function(e){const n=await async function(e){const n=atom.packages.getLoadedPackage(e),t=n&&n.metadata["package-deps"];return Array.isArray(t)?t:[]}(e);return N&&(q(Array.isArray(n),`Dependencies for ${e} are not a valid array`),n.forEach(((n,t)=>{if(Array.isArray(n))n.forEach(((n,r)=>{const o=`Dependency#${t}#${r} for ${e} is invalid`;q("string"==typeof n.name&&n.name.length>0,o),q(null==n.minimumVersion||"string"==typeof n.minimumVersion&&n.minimumVersion.length>0,o)})),q(n.length>0,`Dependency#${t} for ${e} has no group items`);else{const r=`Dependency#${t} for ${e} is invalid`;q("string"==typeof n.name&&n.name.length>0,r),q(null==n.minimumVersion||"string"==typeof n.minimumVersion&&n.minimumVersion.length>0,r)}}))),n}(e);if(0===o.length)return;const a=await Promise.all(o.map((async e=>Array.isArray(e)?Promise.all(e.map(_)):_(e)))),i=await D(a,(async function(e){return Array.isArray(e)?(await Promise.all(e.map((e=>M(e))))).every(Boolean):M(e)}));if(0===i.length)return;let s;if(s=n?i.map((e=>Array.isArray(e)?e[0]:e)):await function({packageName:e,dependencies:n}){return new Promise((t=>{var r;const o=n.filter((e=>!Array.isArray(e))),a=n.filter((e=>Array.isArray(e))),i=0===a.length,s=i?o.map((e=>e.name)).join(", "):"Something went wrong. Check your developer console",l=a.map((e=>e[0]));atom.packages.isPackageDisabled("notifications")&&console.warn(`Enable notifications to install dependencies for ${e}`);const c=atom.notifications.addInfo(`${e} needs to install dependencies`,{dismissable:!0,icon:"cloud-download",detail:s,description:`Install dependenc${1===n.length?"y":"ies"}?`,buttons:[{text:"Yes",onDidClick:()=>{t(i?o:o.concat(l)),c.dismiss()}},{text:"No Thanks",onDidClick:()=>{c.dismiss()}},{text:"Never",onDidClick:()=>{!function(e){var n;const t=new Set(null!==(n=atom.config.get("atom-package-deps.ignored"))&&void 0!==n?n:[]);t.add(e),atom.config.set("atom-package-deps.ignored",Array.from(t))}(e),H&&(H=!1,atom.notifications.addInfo("How to reset package-deps memory",{dismissable:!0,description:"To modify the list of ignored files invoke 'Application: Open Your Config' and change the 'atom-package-deps' section"})),c.dismiss()}}]});if(c.onDidDismiss((()=>t([]))),!i)try{const e=atom.views.getView(c),n=null!==(r=null==e?void 0:e.element)&&void 0!==r?r:null;if(null==n)throw new Error("Unable to get notification element from view");const t=n.querySelector(".detail-content");if(null==t)throw new Error("Content detail container not found inside the notification");if(t.innerHTML="",o.length>0){const e=document.createElement("div");e.innerHTML=`Packages without choices: <br /><ul><li>${o.map((e=>S(e.name))).join("</li><li>")}</li></ul>`,t.appendChild(e)}const i=document.createElement("div");i.innerHTML="Packages with choices:",t.appendChild(i);const s=document.createElement("ul");a.forEach(((e,n)=>{const t=document.createElement("li"),r=document.createElement("select");r.innerHTML=e.map((e=>`<option>${S(e.name)}</option>`)).join("\n"),r.addEventListener("change",(()=>{const t=e.find((e=>e.name===r.value));null!=t&&(l[n]=t)})),t.style.marginTop="5px",t.appendChild(r),s.appendChild(t)})),t.appendChild(s)}catch(e){console.error("[Package-Deps] Error during showing package choices to user",e)}}))}({packageName:e,dependencies:i}),0===s.length)return;const l=function({packageName:e,dependencies:n}){var t;const r=[],o=atom.notifications.addInfo(`Installing ${e} dependencies`,{detail:`Installing ${n.map((e=>e.name)).join(", ")}`,dismissable:!0}),a=document.createElement("progress");a.max=n.length,a.style.width="100%";try{const e=atom.views.getView(o),n=null!==(t=null==e?void 0:e.element)&&void 0!==t?t:null;if(null==n)throw new Error("Unable to get notification element from view");const r=n.querySelector(".detail-content");if(null==r)throw new Error("Content detail container not found inside the notification");r.appendChild(a)}catch(e){console.warn("[Package-Deps] Error during showing installation progress to user",e)}return{handleFailure({dependency:e,error:n}){var t;r.push(e.name),a.value+=1,console.error(`[Package-Deps] Unable to install ${e.name}, Error:`,null!==(t=null==n?void 0:n.stack)&&void 0!==t?t:n)},handleDependencyInstalled(e){a.value+=1},handleComplete(){o.dismiss(),r.length>0?atom.notifications.addWarning(`Failed to install ${e} dependencies`,{detail:`These packages were not installed, check your console\nfor more info.\n${r.join("\n")}`,dismissable:!0}):atom.notifications.addSuccess(`Installed ${e} dependencies`,{detail:`Installed ${n.map((e=>e.name)).join(", ")}`}),Promise.all(n.map((e=>r.includes(e.name)?null:atom.packages.activatePackage(e.name)))).catch((n=>{console.error(`[Package-Deps] Error activating installed packages for ${e}`,n)}))}}}({packageName:e,dependencies:s});await(async(e,n,{concurrency:t=1/0,stopOnError:r=!0}={})=>new Promise(((o,a)=>{if("function"!=typeof n)throw new TypeError("Mapper function is required");if(!Number.isSafeInteger(t)&&t!==1/0||!(t>=1))throw new TypeError(`Expected \`concurrency\` to be an integer from 1 and up or \`Infinity\`, got \`${t}\` (${typeof t})`);const i=[],s=[],l=e[Symbol.iterator]();let c=!1,d=!1,u=0,p=0;const f=()=>{if(c)return;const e=l.next(),t=p;if(p++,e.done)return d=!0,void(0===u&&(r||0===s.length?o(i):a(new P(s))));u++,(async()=>{try{const r=await e.value;i[t]=await n(r,t),u--,f()}catch(e){r?(c=!0,a(e)):(s.push(e),u--,f())}})()};for(let e=0;e<t&&(f(),!d);e++);})))(s,(async function(e){try{await async function(e){const n=`"${atom.packages.getApmPath()}"`,{stdout:t,stderr:r}=await I(n,["install",e.name,"--production","--color","false"],{shell:!0}),o=L.exec(t.trim());if(null!=o&&V.has(o[2]))return;const a=new Error(`Error installing dependency: ${e.name}`);throw a.stack=r.trim(),a}(e),l.handleDependencyInstalled(e)}catch(n){l.handleFailure({dependency:e,error:n})}}),{concurrency:2}),l.handleComplete()},F=Object.freeze(Object.assign(Object.create(null),c,{install:B,default:c}));exports.index=F;
//# sourceMappingURL=index-254fbdfb.js.map
